---
title: "Example 5 : Data Visualization"
output: html_document
date: '2023-03-30'
---

```{r}
library(swat)
# change the host and port to match your site
s <- CAS("cloud.example.com", 10065)
```

This example demonstrates how to create data visualizations using the ggplot2 library in R based on data that has been pre-processed using CAS actions. The data used for this example are 28,347 crime incidents from 2021 provided by the City of Washington, DC.

# Import Libraries

Import the tidyverse and lubridate libraries in R, and load the aggregation CAS action set.

```{r include=FALSE}
library(tidyverse)
library(lubridate)
cas.builtins.loadActionSet(s, actionSet="aggregation")
```

# Load the Data

## Load the Data from a Caslib

The default method of loading data is to load the data from the data source portion of a caslib, which is known as a server-side load. This requires the data file to be saved in the active caslib (Casuser). Once the file has been saved to the caslib, use the table.loadTable action to load the Crime_Incidents_in_2021.csv CSV file from the data source portion of the caslib into memory as a CAS table named crimes.

```{r}
cas.table.loadTable(s, 
                    path="Crime_Incidents_in_2021.csv",
                    caslib="casuser",
                    casOut=list(name="crimes", 
                                replace=TRUE),
                    importOptions=list(fileType="CSV",
                                       encoding="latin1",
                                       guessrows=30000,
                                       vars=list(ward=list(type="VARCHAR"))))
```

## Load a Client-Side Data File into CAS

Another method of loading data into CAS memory is to load the data from an external source that is accessible to the CAS server. This example uses the upload_file function to perform a client-side load.

```{r}
cas.upload.file(s,                                                                        
                "https://support.sas.com/documentation/onlinedoc/viya/exampledatasets/Crime_Incidents_in_2021.csv", 
                casOut=list(name="crimes", 
                            replace=TRUE),
                importOptions=list(fileType="CSV",
                                   encoding="latin1",
                                   guessrows=30000))
```

# Explore the Data

## Create a Reference to the In-Memory Table

Use the defCasTable SWAT function to create a reference to the crimes table and save the result as a object named tbl. Therefore, any action or method that is run on the CAS table object tbl will include the parameters in tbl.

```{r}
tbl <- defCasTable(s, "crimes", caslib="casuser")
```

## Examine the Rows

Use a table.fetch action to retrieve the first five rows from the crimes table.

```{r}
cas.table.fetch(tbl,
                to=5)
```

## Examine the Columns

Use the table.columnInfo action to obtain metadata about the table. The result includes the names of columns, and information about each column, including its label (if applicable), type, length, and format. The results show that the columns are the appropriate types.

```{r}
cas.table.columnInfo(tbl)
```

## Examine Unique and Missing Values

Examine the number of unique and missing values for each variable to determine whether data cleaning is necessary. Run the simple.distinct action to identify the number of distinct values and the number of missing values for each column.

```{r}
cas.simple.distinct(tbl)
```

## Calculate Summary Statistics

Perform exploratory analysis by calculating summary statistics including N, mean, standard deviation, minimum, and maximum for each numeric column in the data frame.

```{r}
cas.simple.summary(tbl)
```

# Visualize the Data

The ggplot function from the ggplot2 library in tidyverse can be used to visualize data that has been pre-processed using CAS actions. This example demonstrates how to create a bar chart, histogram, box plot, and line plot using data that has been pre-processed using CAS actions.

## Bar Chart

Create a bar chart that shows the number of crime incidents by the shift variable.

### Aggregate the Data

First, use the simple.freq action to count the number of rows by shift and use the casOut parameter to save the output to a table named CrimesByShift. Create a CAS table object named tbl_shift to reference the CrimesByShift table.

```{r}
cas.simple.freq(tbl,
                inputs=list("SHIFT"),
                casOut=list(name="CrimesByShift",                      
                            caslib='casuser',
                            replace=TRUE))

tbl_shift <- defCasTable(s, "CrimesByShift", caslib="casuser")
```

### Convert the CAS Table to an R Data Frame

Convert the CrimesByShift table to a CAS data frame using the CAS table object tbl_shift, and then convert the CAS data frame casdf_shift to an R data frame named df_shift. Use head to view rows from df_shift.

```{r}
casdf_shift <- to.casDataFrame(tbl_shift, obs=nrow(tbl_shift))
df_shift <- data.frame(casdf_shift)
head(df_shift)
```

### Plot the Data

Use the ggplot function with the geom_col function to create a bar chart. Specify the R data frame df_shift as the first argument. Specify X_Charvar\_ (shift) as the X-axis variable and X_Frequency\_ as the Y-axis variable, with the bars ordered in descending order by the frequency variable.

```{r}
ggplot(df_shift, aes(x=reorder(X_Charvar_, -X_Frequency_), y=X_Frequency_)) +
  geom_col(fill="grey") +
  labs(x = "Shift", 
       y = "Number of Crime Incidents", 
       title = "Number of Crime Incidents by Shift",
       subtitle = "Washington DC, 2021") +
  theme_minimal()
```

## Histogram

Create a histogram to show the distribution of crime incidents by the count of voting precincts.

### Aggregate the Data

Use the simple.freq action to count the number of rows by the voting precinct and save the resulting output table as CrimesByVP. Create a CAS table object named tbl_vp to reference the CrimesByVP table.

```{r}
cas.simple.freq(s, 
                table=list(caslib="casuser",
                           name="crimes"),
                inputs=list("VOTING_PRECINCT"),
                casOut=list(name="CrimesByVP",                      
                            caslib='casuser',
                            replace=TRUE))

tbl_vp <- defCasTable(s, "CrimesByVP", caslib="casuser")

```

### Convert the CAS Table to an R Data Frame

Convert the CrimesByVP table to a CAS data frame using the CAS table object tbl_vp, and then convert the CAS data frame casdf_vp to an R data frame named df_vp. Use head to view rows from the data frame.

```{r}
casdf_vp <- to.casDataFrame(tbl_vp, obs=nrow(tbl_vp))
df_vp <- data.frame(casdf_vp)
head(df_vp)
```

### Plot the Data

Use the ggplot function with the geom_histogram function to create a histogram to show the distribution of crime incidents. Specify the R data frame df_vp as the first argument and X_Frequency\_ as the X-axis variable.

```{r}
ggplot(df_vp, aes(x=X_Frequency_)) +
  geom_histogram(binwidth=25, color="black", fill="white") +
  labs(x='Crime Incidents',
       y='Count of Voting Precincts',
       title='Distribution of the Frequency of Crime Incidents',
       subtitle='Washington DC, 2021')
```

## Box Plot

Create a Box Plot that shows summary statistics for the number of crime incidents among neighborhood clusters by ward.

### Aggregate the Data

Aggregate the data to count the number of crime incidents by Neighborhood Cluster and Ward and save the resulting output table as CrimesByNCWard. Create a CAS table object named tbl_nc_ward to reference the CrimesByNCWard table.

```{r}
cas.aggregation.aggregate(s,                                                     
                          table=list(name="crimes",
                                     caslib="casuser",
                                     groupby=list(list(name="NEIGHBORHOOD_CLUSTER"), list(name="WARD"))),                     
                          varSpecs=list(list(name="CCN",                          
                                             subset=list("N"))),
                          casOut=list(name="CrimesByNCWard",                        
                                      caslib='casuser',
                                      replace=TRUE))

tbl_nc_ward <- defCasTable(s, "CrimesByNCWard", caslib="casuser")
```

### Convert the CAS Table to an R Data Frame

Convert the CrimesByNCWard table to a CAS data frame using the CAS table object tbl_nc_ward, and then convert the CAS data frame casdf_nc_ward to an R data frame named df_nc_ward. Use head to view the rows.

```{r}
casdf_nc_ward <- to.casDataFrame(tbl_nc_ward, obs=nrow(tbl_nc_ward))
df_nc_ward <- data.frame(casdf_nc_ward)
head(df_nc_ward)
```

### Plot the Data

Use the as.character function to convert the Ward variable to character type. Use ggplot to with the geom_boxplot function to create a boxplot to show the summary statistics for number of crime incidents by Ward. Specify ward as the X-axis variable and X_CCN_Summary_NObs\_ (number of rows) as the Y-axis variable.

```{r}
df_nc_ward$WARD <- as.character(df_nc_ward$WARD)
ggplot(data=df_nc_ward, aes(x=WARD, y=X_CCN_Summary_NObs_)) +
  geom_boxplot() +
  labs(x = 'Ward', 
       y = 'Crime Incidents per Neighborhood Cluster',
       title = 'Box Plot of Summary Statistics by Ward',
       subtitle = 'Washington DC, 2021')
```

## Line Plot

Create a line plot to show the number of crime incidents by month in 2021.

### Convert the CAS Table to an R Data Frame

Convert the crimes in-memory table to a CAS data frame using the CAS table object tbl, and then convert the CAS data frame casdf_crimes to an R data frame named df_crimes. Use head to view the rows.

```{r}
casdf_crimes <- to.casDataFrame(tbl, obs=nrow(tbl))
df_crimes <- data.frame(casdf_crimes)
head(df_crimes)
```

### Create a Date Variable

Use the mutate and as.Date functions to create a new data variable containing only the year, month, and day.

```{r}
df_crimes <- mutate(df_crimes, date = as.Date(df_crimes$REPORT_DAT))
```

### Upload Data Frame to CAS

Use the upload.file function to upload df_crimes to the Casuser caslib as a table named crimes.

```{r include=FALSE}
cas.upload.file(s,
                df_crimes,
                casOut=list(name="crimes",
                            caslib="casuser",
                            replace=TRUE),
                importOptions=list(fileType="csv",
                                   encoding="latin1",
                                   guessRows=30000,
                                   vars=list(date=list(informat="yymmdd10.",   
                                                       format="yymmdd10."))))
```

### Aggregate the Data

Use the aggregation.aggregate action to count the number of rows by month and save the resulting output as a table named CrimesByMonth. Create a CAS table object named tbl_month to reference the CrimesByMonth table.

```{r}
cas.aggregation.aggregate(s,                                                                                  
                          table=list(name="crimes",
                                     caslib="casuser",
                                     groupby=list("date")),                                
                          varSpecs=list(list(name="CCN",
                                             subset=list("N"))),
                          ID="date",                                                     
                          interval="MONTH",                                                                  
                          casOut=list(name="CrimesByMonth",                                                
                                      caslib='casuser',
                                      replace=TRUE))

tbl_month <- defCasTable(s, "CrimesByMonth", caslib="casuser")
```

### Convert the CAS Table to an R Data Frame

Convert the CrimesByMonth table to a CAS data frame using the CAS table object tbl_month, and then convert the CAS data frame casdf_month to an R data frame named df_month. Filter df_month to include only months from 2021 and save the result as df_monthFilter. Use head to view the rows.

```{r}
casdf_month <- to.casDataFrame(tbl_month, obs=nrow(tbl_month))
df_month <- data.frame(casdf_month)
df_month
df_monthFilter <- df_month %>% filter(date != 22646)
head(df_monthFilter)
```

### Plot the Data

Use ggplot with the geom_line function to plot the data to show the number of crime incidents by month. Specify df_monthFilter as the first argument. Specify date_f (month) as the X-axis variable and X_CCN_Summary_NObs\_ (number of rows) as the Y-axis variable and set the group parameter equal to 1.

```{r}
ggplot(df_monthFilter, aes(x=date_f, y=X_CCN_Summary_NObs_, group=1)) +
  geom_line() +
  labs(x = "Month", 
       y = "Number of Crime Incidents",
       title = "Number of Crime Incidents by Month",
       subtitle = "Washington DC, 2021") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 70, vjust = 0.5, hjust=0.5))
```
